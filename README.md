# Telegram 核心群组管理机器人

一个可靠、高效、可定制的 Telegram 群组管理机器人，由一个强大的规则引擎驱动。

## 1. 核心目标

*   **自动化管理**: 提供一个功能完备的规则引擎，能够处理常见的群组管理场景（如关键词回复、广告删除、新成员管理）。
*   **易用性与健壮性**: 规则语言简单直观，非技术背景的管理员也能快速上手。系统具备高容错性，单个规则的错误不会导致整个机器人崩溃。
*   **模块化设计**: 代码架构清晰、模块化，便于未来进行功能扩展和维护。

---

## 2. 规则脚本语言指南 (v2.3)

本机器人由一个强大、灵活的嵌入式脚本语言驱动。它允许您编写复杂的规则来自动化管理您的群组。

### 2.1. 核心概念

*   **语法风格**: 语言采用类似 C/Java/JavaScript 的语法风格。代码块由 `{}` 包裹，每条语句以 `;` 结尾。
*   **声明式与命令式结合**: 规则的总体结构是声明式的 (`WHEN...WHERE...THEN`)，但在 `THEN` 块内部，您可以编写命令式的脚本代码。

### 2.2. 规则基本结构

```
WHEN event
WHERE expression
THEN {
    // 脚本代码...
}
END
```

*   **`WHEN event`**: **必需**。定义规则的**触发器**。
*   **`WHERE expression`**: **可选**。定义规则的**守卫条件**。这是一个高效的前置检查，只有当 `expression` 的结果为真时，`THEN` 块内的脚本才会被执行。
*   **`THEN { ... }`**: **必需**。定义规则的**执行体**。其中包含用于处理事件的脚本。
*   **`END`**: **必需**。标志着规则定义的结束。

### 2.3. 数据类型

*   **String**: 字符串，由 `"` 或 `'` 包裹。例如: `"hello"`, `'world'`。
*   **Number**: 数字，包括整数和浮点数。例如: `123`, `99.9`。
*   **Boolean**: 布尔值，`true` 或 `false`。
*   **Null**: 代表“无”或“空”的值，关键字为 `null`。
*   **List**: 列表（数组），有序的元素集合。例如: `[1, "a", true]`。
*   **Dictionary**: 字典（对象），键值对的集合。键必须是字符串。例如: `{"key": "value", "count": 10}`。

### 2.4. 变量

语言中有三类变量：

1.  **脚本变量 (本地变量)**: 在 `THEN` 块内通过赋值语句创建，只在当前脚本执行期间存在。
    ```
    my_var = 10;
    my_list = [1, 2, 3];
    ```
2.  **上下文变量 (只读)**: 由系统提供，包含了当前触发事件的所有信息。
    *   `user.*`: 触发事件的用户信息。 e.g., `user.id`, `user.is_admin`。
    *   `message.*`: 触发事件的消息信息。 e.g., `message.text`, `message.reply_to_message`。
    *   `command.*`: 当 `WHEN command` 时可用，提供对命令参数的访问。 e.g., `command.full_args`。
3.  **持久化变量 (读写)**: 跨规则、跨时间存在的变量，存储在数据库中。
    *   `vars.group.my_var`: 群组作用域的变量。
    *   `vars.user.my_var`: 用户在特定群组内的作用域变量。
    *   **读取**: `my_warnings = vars.user.warnings or 0;`
    *   **写入**: 必须使用 `set_var` 动作: `set_var("user.warnings", my_warnings + 1);`

### 2.5. 控制流

*   **条件分支**: `if (expression) { ... } else { ... }`
*   **循环**: `foreach (item in collection) { ... }`
*   **循环控制**: `break;` (跳出循环) 和 `continue;` (进入下一次迭代)。

### 2.6. 表达式与运算符

支持标准的运算优先级。

| 类别 | 运算符 |
| :--- | :--- |
| **数学** | `+` (加法, 字符串/列表拼接), `-`, `*`, `/` |
| **比较** | `==`, `!=`, `>`, `>=`, `<`, `<=` |
| **逻辑** | `and`, `or`, `not` (前缀) |
| **字符串** | `contains`, `startswith`, `endswith` |

### 2.7. 内置函数

| 函数 | 描述 |
| :--- | :--- |
| `len(object)` | 返回列表、字典或字符串的长度/大小。 |
| `str(object)` | 将一个对象转换为字符串。 |
| `int(object)` | 尝试将一个对象转换为整数（失败则返回0）。 |
| `lower(string)` | 将字符串转为小写。 |
| `upper(string)` | 将字符串转为大写。 |
| `split(string, separator, maxsplit)` | 将字符串按 `separator` 分割成一个列表。`maxsplit`为可选参数。 |
| `join(list, separator)` | 使用 `separator` 连接 `list` 中的所有元素成一个字符串。 |

### 2.8. 可用动作 (Actions)

动作是脚本与机器人功能交互的唯一方式。

| 动作 | 描述 |
| :--- | :--- |
| `reply(text)` | 回复触发消息。 |
| `send_message(text)` | 在当前群组发送一条新消息。 |
| `delete_message()` | 删除触发当前规则的消息。 |
| `ban_user(user_id, reason)` | 永久封禁用户。`user_id` 和 `reason` 都是可选的。 |
| `kick_user(user_id)` | 将用户踢出群组（可重新加入）。 |
| `mute_user(duration, user_id)` | 禁言用户。`duration` 支持 `m`, `h`, `d` 单位。 |
| `set_var(name, value)` | 设置一个持久化变量 (例如 `"group.my_var"`)。 |
| `stop()` | 立即停止执行，且不再处理后续规则。 |
| `start_verification()` | 对新用户启动人机验证流程。 |

---

## 4. 安装与启动

(此部分保持不变)

---

## 5. 测试

(此部分保持不变)
